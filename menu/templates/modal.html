<div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="loginModalLabel">BiciCenter</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="login-tab" data-bs-toggle="tab" data-bs-target="#login" type="button" role="tab" aria-controls="login" aria-selected="true">Iniciar Sesión</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="register-tab" data-bs-toggle="tab" data-bs-target="#register" type="button" role="tab" aria-controls="register" aria-selected="false">Registrarse</button>
                    </li>
                </ul>
                <div class="tab-content" id="myTabContent">
                    <div class="tab-pane fade show active" id="login" role="tabpanel" aria-labelledby="login-tab">
                        <form id="loginForm" action="{% url 'inicioSesion' %}" method="POST" class="mt-3">
                            {% csrf_token %}
                            <input type="hidden" name="next" value="{{ request.path }}">
                            <div id="login-alert" class="alert alert-danger d-none"></div>
                            <div class="mb-3">
                                <label for="id_username" class="form-label">Usuario</label>
                                <input type="text" class="form-control" id="id_username" name="username" required>
                            </div>
                            <div class="mb-3">
                                <label for="id_password" class="form-label">Contraseña</label>
                                <input type="password" class="form-control" id="id_password" name="password" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Entrar</button>
                        </form>
                    </div>
                    <div class="tab-pane fade" id="register" role="tabpanel" aria-labelledby="register-tab">
                        <form id="registerForm" action="{% url 'registro' %}" method="POST" class="mt-3">
                            {% csrf_token %}
                            <input type="hidden" name="next" value="{{ request.path }}">
                            <div id="register-alert" class="alert alert-danger d-none"></div>
                            <div class="mb-3">
                                <label for="id_first_name" class="form-label">Nombre</label>
                                <input type="text" class="form-control" id="id_first_name" name="first_name" required>
                            </div>
                            <div class="mb-3">
                                <label for="id_last_name" class="form-label">Apellido</label>
                                <input type="text" class="form-control" id="id_last_name" name="last_name" required>
                            </div>
                            <div class="mb-3">
                                <label for="id_username_reg" class="form-label">Usuario</label>
                                <input type="text" class="form-control" id="id_username_reg" name="username" required>
                            </div>
                            <div class="mb-3">
                                <label for="id_email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="id_email" name="email" required>
                            </div>
                            <div class="mb-3">
                                <label for="id_rut" class="form-label">RUT</label>
                                <input type="text" class="form-control" id="id_rut" name="rut" required>
                            </div>
                            <div class="mb-3">
                                <label for="id_password_reg" class="form-label">Contraseña</label>
                                <input type="password" class="form-control" id="id_password_reg" name="password" required>
                            </div>
                            <div class="mb-3">
                                <label for="id_password2" class="form-label">Confirmar Contraseña</label>
                                <input type="password" class="form-control" id="id_password2" name="password2" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Registrarse</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
document.getElementById('loginForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    const alertDiv = document.getElementById('login-alert');

    try {
        const response = await fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        });

        const data = await response.json();

        if (data.success) {
            window.location.href = data.redirect_url;
        } else {
            alertDiv.textContent = data.message;
            alertDiv.classList.remove('d-none');
        }
    } catch (error) {
        alertDiv.textContent = 'Ocurrió un error inesperado. Por favor, intente de nuevo.';
        alertDiv.classList.remove('d-none');
    }
});

document.getElementById('registerForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    const alertDiv = document.getElementById('register-alert');

    try {
        const response = await fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        });

        const data = await response.json();

        if (data.success) {
            window.location.href = data.redirect_url;
        } else {
            alertDiv.textContent = data.message;
            alertDiv.classList.remove('d-none');
        }
    } catch (error) {
        alertDiv.textContent = 'Ocurrió un error inesperado. Por favor, intente de nuevo.';
        alertDiv.classList.remove('d-none');
    }
});
</script>